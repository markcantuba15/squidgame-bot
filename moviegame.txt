


// --- NEW GAME 10: MOVIE EMOJI GUESS ---

// Make sure GROUP_CHAT_ID is defined (as discussed previously)
// const GROUP_CHAT_ID = -123456789; // <<< REPLACE WITH YOUR ACTUAL GROUP CHAT ID

let game10Active = false;
let game10Data = {}; // { userId: { emoji, answer, guessesLeft, timeout } }
let game10CurrentEmoji = null; // Stores the emoji combo currently being guessed in the group
let game10CurrentAnswer = null; // Stores the answer (movie title) for the current emoji

// List of movie-themed emojis and their answers. EXPAND THIS LIST!
const movieEmojiList = [
  { emoji: "ðŸ¦ðŸ‘‘", answer: "The Lion King" },
  { emoji: "ðŸ•·ï¸ðŸ§‘", answer: "Spider-Man" },
  { emoji: "ðŸ§™â€â™‚ï¸ðŸª„", answer: "Harry Potter" },
  { emoji: "ðŸ§ŠðŸš¢", answer: "Titanic" },
  { emoji: "ðŸ¦‡ðŸ§‘", answer: "Batman" },
  { emoji: "ðŸ ðŸ”", answer: "Finding Nemo" },
  { emoji: "ðŸ¦•ðŸŒ‹", answer: "Jurassic Park" },
  { emoji: "ðŸ¤ ðŸš€", answer: "Toy Story" },
  { emoji: "â„ï¸ðŸ‘­", answer: "Frozen" },
  { emoji: "ðŸ­ðŸ‘‘", answer: "Cinderella" },
  { emoji: "ðŸ‘¸ðŸŽ", answer: "Snow White" },
  { emoji: "ðŸ§žâ€â™‚ï¸ðŸ•Œ", answer: "Aladdin" },
  { emoji: "ðŸ˜ðŸŽª", answer: "Dumbo" },
  { emoji: "ðŸŽˆðŸ ", answer: "Up" },
  { emoji: "ðŸ‘¸ðŸ¸", answer: "The Princess and the Frog" },
  { emoji: "ðŸŽ­ðŸŽ©", answer: "The Greatest Showman" },
  { emoji: "ðŸ‘½â˜Žï¸", answer: "E.T." },
  { emoji: "ðŸ’ðŸŒ‹", answer: "Lord of the Rings" },
  { emoji: "ðŸ‘»ðŸš«", answer: "Ghostbusters" },
  { emoji: "ðŸŽï¸ðŸ”¥", answer: "Cars" },
  { emoji: "ðŸ§”âš¡", answer: "Shazam" },
  { emoji: "ðŸ¼ðŸ¥‹", answer: "Kung Fu Panda" },
  { emoji: "ðŸ§™â€â™‚ï¸â›°ï¸", answer: "The Hobbit" },
  { emoji: "ðŸ‘“ðŸª„", answer: "Fantastic Beasts" },
  { emoji: "ðŸ‰ðŸ”¥", answer: "How to Train Your Dragon" },
  { emoji: "ðŸ‘¨â€ðŸš€ðŸŒŒ", answer: "Interstellar" },
  { emoji: "ðŸï¸ðŸ", answer: "Cast Away" },
  { emoji: "ðŸ‘§ðŸ•", answer: "Lassie" },
  { emoji: "ðŸ’‚â€â™‚ï¸ðŸ‡¬ðŸ‡§", answer: "Paddington" },
  { emoji: "ðŸ‘¨â€ðŸ³ðŸ€", answer: "Ratatouille" },
  { emoji: "ðŸŽ¬ðŸ•°ï¸", answer: "Back to the Future" },
  { emoji: "ðŸ§›â€â™‚ï¸ðŸ©¸", answer: "Dracula" },
  { emoji: "ðŸš¢ðŸ™", answer: "Pirates of the Caribbean" },
  { emoji: "ðŸ•µï¸â€â™‚ï¸ðŸ”", answer: "Sherlock Holmes" },
  { emoji: "ðŸš€ðŸ‘¨â€ðŸš€", answer: "Lightyear" },
  { emoji: "ðŸŒŠðŸ‘¨â€ðŸ‘¦", answer: "The Way of Water" },
  { emoji: "ðŸ‘®â€â™‚ï¸ðŸ¤–", answer: "RoboCop" },
  { emoji: "ðŸ‘©â€â¤ï¸â€ðŸ‘¨ðŸ’”", answer: "The Notebook" },
  { emoji: "ðŸŽ¤ðŸ‘©", answer: "Pitch Perfect" },
  { emoji: "ðŸ°ðŸ€", answer: "Space Jam" }
];


bot.onText(/\/startmoviegame/, async (msg) => {
  if (msg.from.id !== ADMIN_ID) return;
  if (game10Active) return bot.sendMessage(msg.chat.id, "âš ï¸ Game 10 (Movie Emoji Guess) is already running.");

  let players = JSON.parse(fs.readFileSync("players.json"));
  let alivePlayers = players.filter(p => p.status === "alive" || p.status === "safe");

  if (alivePlayers.length === 0) {
    return bot.sendMessage(msg.chat.id, "âŒ No alive players found to play Game 10.");
  }

  game10Active = true;
  game10Data = {};

  // Select a random movie emoji from the list
  const randomIndex = Math.floor(Math.random() * movieEmojiList.length);
  const selectedMovieEmoji = movieEmojiList[randomIndex];
  game10CurrentEmoji = selectedMovieEmoji.emoji;
  // Store answer in lowercase for easier comparison, removing common non-alphanumeric chars
  game10CurrentAnswer = selectedMovieEmoji.answer.toLowerCase().replace(/[^a-z0-9]/g, '');

  // Send emoji to the group chat
  bot.sendMessage(GROUP_CHAT_ID,
    `ðŸŽ¬ *Game 10: Movie Emoji Guess!* ðŸŽ¬\nI'm thinking of a famous movie represented by these emojis. DM me your guess!\nYou have *3 guesses* and *1 minute* to figure it out.\n\nGuess the movie: ${game10CurrentEmoji}`,
    { parse_mode: "Markdown" }
  );

  // Prepare game data for all alive players
  for (const player of alivePlayers) {
    game10Data[player.id] = {
      emoji: game10CurrentEmoji,
      answer: game10CurrentAnswer,
      guessesLeft: 3,
      timeout: setTimeout(() => {
        // If a player never DMs to start, or runs out of time without guessing correctly
        if (game10Active && game10Data[player.id]) {
          const username = getUsernameById(player.id);
          bot.sendMessage(GROUP_CHAT_ID, `â° *${username}* ran out of time for Game 10 and is eliminated! The movie was *${selectedMovieEmoji.answer}*.`, { parse_mode: "Markdown" });
          eliminatePlayer(player.id);
          delete game10Data[player.id];
          checkGame10End();
        }
      }, 1 * 60 * 1000) // 1 minute timeout
    };
    // Inform individual players in DM
    bot.sendMessage(player.id,
      `ðŸŽ¯ *Game 10: Movie Emoji Guess!*\nThe emojis sent to the group chat are: ${game10CurrentEmoji}\nWhat movie do these represent? You have *3 guesses* and *1 minute*!`,
      { parse_mode: "Markdown" });
  }

  bot.sendMessage(msg.chat.id, `ðŸŽ® Game 10 (Movie Emoji Guess) started. Emojis sent to group. Players must DM the bot to play.`);
});


// Handle player guesses in DM
bot.on("message", (msg) => {
  const userId = msg.from.id;
  const text = msg.text;

  // Only handle DMs & when Game 10 is active, and the user is part of the current game
  if (msg.chat.type !== "private") return;
  if (!game10Active || !game10Data[userId]) return;

  const data = game10Data[userId];
  // Normalize guess: convert to lowercase and remove non-alphanumeric characters for flexible matching
  const guess = text.toLowerCase().replace(/[^a-z0-9]/g, '');

  // If a player has no guesses left, ignore further messages
  if (data.guessesLeft <= 0) {
    return bot.sendMessage(userId, "You've already used all your guesses or completed this round.");
  }

  data.guessesLeft--; // Decrement guesses

  if (guess === data.answer) {
    clearTimeout(data.timeout);
    markSafe(userId); // Mark player safe

    const username = getUsernameById(userId);
    // Use the original (non-normalized) answer for display
    const originalAnswer = movieEmojiList.find(item => item.emoji === data.emoji)?.answer || data.answer;

    bot.sendMessage(userId, `ðŸŽ‰ Correct! The movie was *${originalAnswer}*. You're safe!`, { parse_mode: "Markdown" });
    bot.sendMessage(GROUP_CHAT_ID, `ðŸŽ‰ *${username}* has correctly guessed the movie: *${originalAnswer}*! They are safe!`, { parse_mode: "Markdown" });

    delete game10Data[userId]; // Remove player from active game
    checkGame10End(); // Check if all players are done
  } else if (data.guessesLeft === 0) {
    clearTimeout(data.timeout);
    eliminatePlayer(userId); // Eliminate player

    const username = getUsernameById(userId);
    const originalAnswer = movieEmojiList.find(item => item.emoji === data.emoji)?.answer || data.answer;

    bot.sendMessage(userId, `â˜ ï¸ Out of guesses! The movie was *${originalAnswer}*. You're eliminated.`, { parse_mode: "Markdown" });
    bot.sendMessage(GROUP_CHAT_ID, `â˜ ï¸ *${username}* ran out of guesses for the movie emoji! They are eliminated. The movie was *${originalAnswer}*.`, { parse_mode: "Markdown" });

    delete game10Data[userId]; // Remove player from active game
    checkGame10End(); // Check if all players are done
  } else {
    bot.sendMessage(userId, `âŒ Incorrect! You have ${data.guessesLeft} guess(es) left. Keep guessing the movie!`);
  }
});


// Helper function to check if all players have finished Game 10
function checkGame10End() {
  if (Object.keys(game10Data).length === 0 && game10Active) {
    game10Active = false;
    game10CurrentEmoji = null;
    game10CurrentAnswer = null;
    bot.sendMessage(GROUP_CHAT_ID, "ðŸ Game 10: Movie Emoji Guess has ended! All active players have completed their attempts.", { parse_mode: "Markdown" });
  }
}bot.onText(/\/kupal_id/, (msg) => {
  const userId = msg.from.id;
  const username = msg.from.username;
  console.log("User ID:", userId, "Username:", username);
  bot.sendMessage(msg.chat.id, `Your Telegram user ID is: ${userId}`);
});